{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "serverNodeCount": {
            "defaultValue": 1,
            "allowedValues": [
                1,
                3,
                5
            ],
            "minValue": 1,
            "maxValue": 5,
            "type": "int",
            "metadata": {
                "description": "Number of server nodes (? or less). Should be an odd number. If single node ignored?"
            }
        },
        "serverNodeInstanceType": {
            "type": "string",
            "defaultValue": "Standard_D16s_v3",
            "allowedValues": [
                "Standard_D16s_v3",
                "Standard_D32s_v3"
            ],
            "metadata": {
                "description": "Instance type of a server node"
            }
        },
        "agentNodeCount": {
            "type": "int",
            "defaultValue": 1,
            "minValue": 0,
            "maxValue": 3,
            "allowedValues": [
                0,
                1,
                2,
                3
            ],
            "metadata": {
                "description": "Number of agent nodes (? or less)"
            }
        },
        "agentNodeInstanceType": {
            "type": "string",
            "defaultValue": "Standard_D16s_v3",
            "allowedValues": [
                "Standard_D16s_v3",
                "Standard_D32s_v3"
            ],
            "metadata": {
                "description": "Instance type of an agent node"
            }
        },
        "gpuNodeCount": {
            "type": "int",
            "defaultValue": 0,
            "minValue": 0,
            "maxValue": 2,
            "allowedValues": [
                0,
                1,
                2
            ],
            "metadata": {
                "description": "Number of agent nodes with GPU capabilities (? or less)"
            }
        },
        "gpuNodeInstanceType": {
            "type": "string",
            "defaultValue": "Standard_NC12s_v3",
            "allowedValues": [
                "Standard_NC8as_T4_v3",
                "Standard_NC12s_v3",
                "Standard_NC24s_v3"
            ],
            "metadata": {
                "description": "Instance type of a gpu agent node"
            }
        },
        "taskMiningNodeType": {
            "type": "string",
            "defaultValue": "Standard_D32s_v3",
            "allowedValues": [
                "Standard_F32s_v2",
                "Standard_B20ms",
                "Standard_D32s_v3"
            ],
            "metadata": {
                "description": "OPTIONAL: Instance type of the task mining node. This will only be used if you enable task mining."
            }
        },
        "SQLServerUsername": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "SQL Server user login. If the 'SQLNewOrExisting' parameter is set to `existing` this is the user for the existing SQL server. Otherwise this username will be set on the SQL server created. Please see this link for permissions: https://docs.uipath.com/automation-suite/docs/multi-node-configuring-ms-sql-server#permissions"
            }
        },
        "SQLServerPassword": {
            "type": "securestring",
            "defaultValue": "",
            "metadata": {
                "description": "SQL Server user password. If the 'SQLNewOrExisting' parameter is set to `existing` this is the user password for the existing SQL server. Otherwise this password will be set on the SQL server created."
            }
        },
        "UipathAdminUsername": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "UiPath Automation Suite User login"
            }
        },
        "UipathAdminPassword": {
            "type": "securestring",
            "defaultValue": "",
            "metadata": {
                "description": "UiPath Automation Suite User password"
            }
        },
        "vmAdminUsername": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Virtual Machine User login"
            }
        },
        "vmAdminPassword": {
            "type": "securestring",
            "defaultValue": "",
            "metadata": {
                "description": "Virtual Machine User password"
            }
        },
        "actionCenterInstallFlag": {
            "type": "bool",
            "defaultValue": false,
            "metadata": {
                "description": "Flag which determines whether Action Center should be installed."
            }
        },
        "testManagerInstallFlag": {
            "type": "bool",
            "defaultValue": false,
            "metadata": {
                "description": "Flag which determines whether Test Manager should be installed."
            }
        },
        "insightsInstallFlag": {
            "type": "bool",
            "defaultValue": false,
            "metadata": {
                "description": "Flag which determines whether Insights should be installed."
            }
        },
        "dataServiceInstallFlag": {
            "type": "bool",
            "defaultValue": false,
            "metadata": {
                "description": "Flag which determines whether Data Service should be installed."
            }
        },
        "automationHubInstallFlag": {
            "type": "bool",
            "defaultValue": false,
            "metadata": {
                "description": "Flag which determines whether Automation Hub should be installed."
            }
        },
        "automationOpsInstallFlag": {
            "type": "bool",
            "defaultValue": false,
            "metadata": {
                "description": "Flag which determines whether Automation Ops should be installed."
            }
        },
        "appsInstallFlag": {
            "type": "bool",
            "defaultValue": false,
            "metadata": {
                "description": "Flag which determines whether Apps should be installed."
            }
        },
        "aiCenterInstallFlag": {
            "type": "bool",
            "defaultValue": false,
            "metadata": {
                "description": "Flag which determines whether AI Center should be installed."
            }
        },
        "taskMiningInstallFlag": {
            "type": "bool",
            "defaultValue": false,
            "metadata": {
                "description": "Flag which determines whether Task Mining should be installed."
            }
        },
        "documentUnderstandingInstallFlag": {
            "type": "bool",
            "defaultValue": false,
            "metadata": {
                "description": "Flag which determines whether Document Understanding should be installed."
            }
        }
    },
    "variables": {
        "preValidateTemplateUri": "https://download.uipath.com/templates/AutomationSuite/Azure/2022.4.3/LinkedTemplates/preValidate.json",
        "automationsTemplateUri": "https://download.uipath.com/templates/AutomationSuite/Azure/2022.4.3/LinkedTemplates/automations.json",
        "databaseTemplateUri": "https://download.uipath.com/templates/AutomationSuite/Azure/2022.4.3/LinkedTemplates/database.json",
        "networkTemplateUri": "https://download.uipath.com/templates/AutomationSuite/Azure/2022.4.3/LinkedTemplates/network.json",
        "backupTemplateUri": "https://download.uipath.com/templates/AutomationSuite/Azure/2022.4.3/LinkedTemplates/backup.json",
        "computeTemplateUri": "https://download.uipath.com/templates/AutomationSuite/Azure/2022.4.3/LinkedTemplates/compute.json",
        "dnsTemplateUri": "https://download.uipath.com/templates/AutomationSuite/Azure/2022.4.3/LinkedTemplates/dns.json",
        "vaultTemplateUri": "https://download.uipath.com/templates/AutomationSuite/Azure/2022.4.3/LinkedTemplates/vault.json",
        "storageTemplateUri": "https://download.uipath.com/templates/AutomationSuite/Azure/2022.4.3/LinkedTemplates/storage.json",
        "postInstallValidationTemplateUri": "https://download.uipath.com/templates/AutomationSuite/Azure/2022.4.3/LinkedTemplates/postInstallValidation.json",
        "removeNodeUtilsUrl": "https://download.uipath.com/templates/AutomationSuite/Azure/2022.4.3/scripts/ASNodeRemoveUtils.zip",
        "removeNodeScriptUrl": "https://download.uipath.com/templates/AutomationSuite/Azure/2022.4.3/scripts/removeNode.sh",
        "scriptUris": {
            "validateDeploymentParameters": "https://download.uipath.com/templates/AutomationSuite/Azure/2022.4.3/scripts/validateDeploymentParameters.ps1",
            "diskResize": "https://download.uipath.com/templates/AutomationSuite/Azure/2022.4.3/scripts/diskresize.sh",
            "installPrereq": "https://download.uipath.com/templates/AutomationSuite/Azure/2022.4.3/scripts/installPrereq.sh",
            "installServer": "https://download.uipath.com/templates/AutomationSuite/Azure/2022.4.3/scripts/installServer.sh",
            "installAgent": "https://download.uipath.com/templates/AutomationSuite/Azure/2022.4.3/scripts/installAgent.sh",
            "installGpuAgent": "https://download.uipath.com/templates/AutomationSuite/Azure/2022.4.3/scripts/installGpuAgent.sh",
            "continueInstallGpuAgent": "https://download.uipath.com/templates/AutomationSuite/Azure/2022.4.3/scripts/continueInstallGpuAgent.sh",
            "continueInstallServer": "https://download.uipath.com/templates/AutomationSuite/Azure/2022.4.3/scripts/continueInstallServer.sh",
            "validateFullInstall": "https://download.uipath.com/templates/AutomationSuite/Azure/2022.4.3/scripts/validateFullInstall.sh",
            "removeNode": "[variables('removeNodeScriptUrl')]",
            "instanceTermination": "https://download.uipath.com/templates/AutomationSuite/Azure/2022.4.3/scripts/instanceTermination.sh"
        },
        "scriptsAndModulesObject": {
            "runbookScripts": [
                {
                    "name": "InstanceRefresh",
                    "url": "https://download.uipath.com/templates/AutomationSuite/Azure/2022.4.3/scripts/aaInstanceRefresh.ps1",
                    "version": "1.0.0.0",
                    "type": "PowerShell",
                    "description": "Runbook to perform instance refresh on an Automation Suite cluster."
                },
                {
                    "name": "RemoveServers",
                    "url": "https://download.uipath.com/templates/AutomationSuite/Azure/2022.4.3/scripts/aaRemoveServers.ps1",
                    "version": "1.0.0.0",
                    "type": "PowerShell",
                    "description": "Runbook to perform server removal from the Automation Suite cluster."
                },
                {
                    "name": "RemoveNodes",
                    "url": "https://download.uipath.com/templates/AutomationSuite/Azure/2022.4.3/scripts/aaRemoveNodes.ps1",
                    "version": "1.0.0.0",
                    "type": "PowerShell",
                    "description": "Runbook to perform specific node removal from the Automation Suite cluster."
                },
                {
                    "name": "ImportASModules",
                    "url": "https://download.uipath.com/templates/AutomationSuite/Azure/2022.4.3/scripts/aaImportModules.ps1",
                    "version": "1.0.0.0",
                    "type": "PowerShell",
                    "description": "Runbook to import the modules needed by the Automation Suite runbooks."
                },
                {
                    "name": "CheckServerZoneResilience",
                    "url": "https://download.uipath.com/templates/AutomationSuite/Azure/2022.4.3/scripts/aaCheckServerZoneResilience.ps1",
                    "version": "1.0.0.0",
                    "type": "PowerShell",
                    "description": "Runbook to check the server zone resilience and tries to distribute a node to other Availability Zone if needed."
                }
            ],
            "modules": [
                {
                    "name": "removeNodeUtils",
                    "url": "[variables('removeNodeUtilsUrl')]"
                }
            ]
        },
        "automationAccountAdditionalVariables": [
            {
                "name": "removeNodeScriptURL",
                "description": "URL of the script used to remove a node from Automation Suite Cluster",
                "value": "[concat('\"', variables('removeNodeScriptUrl'), '\"')]"
            },
            {
                "name": "removeNodeUtilsURL",
                "description": "URL of the utils module used to remove a node from Automation Suite Cluster",
                "value": "[concat('\"', variables('removeNodeUtilsUrl'), '\"')]"
            }
        ],
        "URLFromVersion": "https://download.uipath.com/automation-suite/2022.4.0/installer-2022.4.0.zip",
        "automationSuiteInstallerURL": "[variables('URLFromVersion')]",
        "baseName": "[substring(concat('u',uniqueString(resourceGroup().id, deployment().name)), 0, 5)]",
        "preChecksDeploymentName": "[concat('PreChecks-',substring(uniqueString(variables('baseName')),0,6))]",
        "automationsDeploymentName": "[concat('automations-',substring(uniqueString(variables('baseName')),0,6))]",
        "vaultDeploymentName": "[concat('Vault-',substring(uniqueString(variables('baseName')),0,6))]",
        "storageDeploymentName": "[concat('Storage-',substring(uniqueString(variables('baseName')),0,6))]",
        "postInstallValidationDeploymentName": "[concat('PostInstallValidation-',substring(uniqueString(variables('baseName')),0,6))]",
        "networkDeploymentName": "[concat('Network-',substring(uniqueString(variables('baseName')),0,6))]",
        "backupDeploymentName": "[concat('Backup-',substring(uniqueString(variables('baseName')),0,6))]",
        "dnsDeploymentName": "[concat('DNS-',substring(uniqueString(variables('baseName')),0,6))]",
        "databaseDeploymentName": "[concat('Database-',substring(uniqueString(variables('baseName')),0,6))]",
        "computeDeploymentName": "[concat('Compute-',substring(uniqueString(variables('baseName')),0,6))]",
        "certificateConfig": {
            "enableCustomCertificates": "[bool('false')]",
            "customServerCertificate": "",
            "customServerCertKey": "",
            "customServerCertAuthorityBundle": ""
        },
        "dnsLoadBalancer": "[concat('u',uniqueString(resourceGroup().id, deployment().name))]",
        "location": "westeurope",
        "enabledServices": {
            "sharedSuite": {
                "flag": true,
                "eval": {
                    "core": 14.3,
                    "ram": 8900
                },
                "ha": {
                    "core": 11,
                    "ram": 27000
                }
            },
            "orchestrator": {
                "flag": true,
                "eval": {
                    "core": 2.6,
                    "ram": 3100
                },
                "ha": {
                    "core": 2.6,
                    "ram": 5000
                }
            },
            "actionCenter": {
                "flag": "[parameters('actionCenterInstallFlag')]",
                "eval": {
                    "core": 1,
                    "ram": 2400
                },
                "ha": {
                    "core": 2,
                    "ram": 4000
                }
            },
            "apps": {
                "flag": "[parameters('appsInstallFlag')]",
                "eval": {
                    "core": 2.325,
                    "ram": 7100
                },
                "ha": {
                    "core": 7.25,
                    "ram": 18000
                }
            },
            "automationHub": {
                "flag": "[parameters('automationHubInstallFlag')]",
                "eval": {
                    "core": 0.9,
                    "ram": 1100
                },
                "ha": {
                    "core": 1.9,
                    "ram": 3000
                }
            },
            "taskMining": {
                "flag": "[parameters('taskMiningInstallFlag')]",
                "eval": {
                    "core": 4.2,
                    "ram": 5000
                },
                "ha": {
                    "core": 8,
                    "ram": 9276
                }
            },
            "documentUnderstanding": {
                "flag": "[parameters('documentUnderstandingInstallFlag')]",
                "eval": {
                    "core": 1.5,
                    "ram": 2500
                },
                "ha": {
                    "core": 8.2,
                    "ram": 18000
                }
            },
            "insights": {
                "flag": "[parameters('insightsInstallFlag')]",
                "eval": {
                    "core": 1.5,
                    "ram": 4900
                },
                "ha": {
                    "core": 1.5,
                    "ram": 4900
                }
            },
            "automationOps": {
                "flag": "[parameters('automationOpsInstallFlag')]",
                "eval": {
                    "core": 0.4,
                    "ram": 900
                },
                "ha": {
                    "core": 0.7,
                    "ram": 1710
                }
            },
            "testManager": {
                "flag": "[parameters('testManagerInstallFlag')]",
                "eval": {
                    "core": 0.3,
                    "ram": 400
                },
                "ha": {
                    "core": 1,
                    "ram": 2056
                }
            },
            "aiCenter": {
                "flag": "[parameters('aiCenterInstallFlag')]",
                "eval": {
                    "core": 2.4,
                    "ram": 6000
                },
                "ha": {
                    "core": 4.8,
                    "ram": 13000
                }
            },
            "dataService": {
                "flag": "[parameters('dataServiceInstallFlag')]",
                "eval": {
                    "core": 0.33,
                    "ram": 612
                },
                "ha": {
                    "core": 0.44,
                    "ram": 840
                }
            }
        },
        "existingSQL": "[bool('false')]",
        "templateVersionTag": {
            "templateVersion": "22.4.3"
        }
    },
    "functions": [],
    "outputs": {
        "Documentation": {
            "type": "string",
            "value": "https://docs.uipath.com/automation-suite/docs/automation-suite-overview"
        },
        "URL": {
            "type": "string",
            "value": "[concat('https://',reference(variables('networkDeploymentName')).outputs.loadBalancerFQDN.value)]"
        },
        "keyVaultURL": {
            "type": "string",
            "value": "[concat('https://portal.azure.com/#@/resource', reference(variables('vaultDeploymentName')).outputs.KVResourceId.value)]"
        },
        "ArgoCDURL": {
            "type": "string",
            "value": "[concat('https://alm.',reference(variables('networkDeploymentName')).outputs.loadBalancerFQDN.value)]"
        },
        "ArgoCDPasswordSecretURL": {
            "type": "string",
            "value": "[concat('https://portal.azure.com/#@/asset/Microsoft_Azure_KeyVault/Secret/',reference(variables('vaultDeploymentName')).outputs.argoCDPasswordSecretURL.value)]"
        },
        "ArgoCDUserPasswordSecretURL": {
            "type": "string",
            "value": "[concat('https://portal.azure.com/#@/asset/Microsoft_Azure_KeyVault/Secret/',reference(variables('vaultDeploymentName')).outputs.argoCDUserPasswordSecretURL.value)]"
        },
        "HostAdminUsernameSecretURL": {
            "type": "string",
            "value": "[concat('https://portal.azure.com/#@/asset/Microsoft_Azure_KeyVault/Secret/',reference(variables('vaultDeploymentName')).outputs.adminUsernameSecretURL.value)]"
        },
        "HostAdminPasswordSecretURL": {
            "type": "string",
            "value": "[concat('https://portal.azure.com/#@/asset/Microsoft_Azure_KeyVault/Secret/',reference(variables('vaultDeploymentName')).outputs.adminPasswordSecretURL.value)]"
        }
    }
}
